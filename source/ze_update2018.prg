/*
ZE_UPDATE2018 - Conversões 2018
2018 José Quintas

2018.04.03 Movidas atualizações permanentes pra este fonte
2018.07.03 Correção de NCM perdido pra 3 empresas
*/

#include "directry.ch"

FUNCTION ze_Update2018()

   IF AppVersaoDbfAnt() < 20180501; Costureiras(); ENDIF
   IF AppVersaoDbfAnt() < 20180704; NCMPerdido(); ENDIF
   IF AppVersaoDbfAnt() < 20170816; RemoveLixo();       ENDIF
   IF AppVersaoDbfAnt() < 20170820; pw_DeleteInvalid(); ENDIF // Último, pra remover desativados
   // IF AppVersaoDbfAnt() < 20180401; Update20180401();   ENDIF

   RETURN NIL

STATIC FUNCTION Costureiras()

   LOCAL oElement, aList := { ;
      { "020000", "REMESSA PRA CORTE", "C+5" }, ;
      { "021000", "REMESSA PRA SELO", "C+6" }, ;
      { "022000", "REMESSA PRA COSTURA", "C+7" }, ;
      { "023000", "REMESSA PRA EMBALAGEM", "C+8" }, ;
      { "024000", "CORTE INTERNO", "C+9" }, ;
      { "030020", "RETORNO DE CORTE", "C-5,C+9" }, ;
      { "031021", "RETORNO DE SELO", "C-6,C+9" }, ;
      { "032022", "RETORNO DE COSTURA", "C-7,C+9" }, ;
      { "033023", "RETORNO DE EMBALAGEM", "C-8,C+9" } }

   IF ! "DRICAR" $ AppEmpresaApelido()
      RETURN NIL
   ENDIF
   IF ! AbreArquivos( "jptransa" )
      RETURN NIL
   ENDIF
   FOR EACH oElement IN aList
      IF ! Encontra( oElement[ 1 ], "jptransa", "numlan" )
         RecAppend()
         REPLACE ;
            jptransa->trTransa WITH oElement[ 1 ], ;
            jptransa->trDescri WITH oElement[ 2 ], ;
            jptransa->trReacao WITH oElement[ 3 ]
         RecUnlock()
      ENDIF
   NEXT
   CLOSE DATABASES

   RETURN NIL

STATIC FUNCTION RemoveLixo( ... )

   LOCAL acMaskList, acFileList, oFile, oMask, cPath

   acMaskList := hb_AParams()

   IF Len( acMaskList ) != 0
      FOR EACH oMask IN acMaskList
         cPath := iif( "\" $ oMask, Substr( oMask, 1, Rat( "\", oMask ) ), "" )
         acFileList := Directory( oMask )
         FOR EACH oFile IN acFileList
            fErase( cPath + oFile[ F_NAME ] )
            Errorsys_WriteErrorLog( "Eliminado arquivo desativado " + cPath + oFile[ F_NAME ] )
         NEXT
      NEXT
      RETURN NIL
   ENDIF
   RemoveLixo( "*.lzh", "*.tmp", "*.prn", "*.idx", "*.ndx", "*.cnf", "*.fpt", "*.ftp", "*.vbs", "*.car" )
   RemoveLixo( "temp\*.tmp", "jpawprt.exe", "getmail.exe", "*.htm", "rastrea.dbf", "jplicmov.dbf" )
   RemoveLixo( "rastrea.cdx", "jplicmov.cdx", "ts069", "ts086", "jpa.cfg.backup", "msg_os_fornecedor.txt" )
   RemoveLixo( "jpordser.dbf", "jpcotaca.dbf", "jpvvdem.dbf", "jpvvfin.dbf", "jpordbar.dbf" )
   RemoveLixo( "jpaprint.cfg", "preto.jpg", "jpnfexx.dbf", "aobaagbe", "bbchdjfe", "ajuda.hlp" )
   RemoveLixo( "jpaerror.txt", "ads.ini", "adslocal.cfg", "setupjpa.msi", "duplicados.txt" )
   RemoveLixo( "jpanpins.dbf", "jpanpope.dbf", "jpanpage.dbf", "ba_auto.dbf", "ba_grup.dbf" )
   RemoveLixo( "ba_movi.dbf", "jpnfexml.dbf" )

   RETURN NIL

STATIC FUNCTION NCMPerdido()

   LOCAL oElement, aList := {}

   IF ! AppEmpresaApelido() $ "PEATON,UNIFILA,LOCAFACIL"
      RETURN NIL
   ENDIF

   SayScroll( "Recuperando NCM" )
   IF AppEmpresaApelido() $ "LOCAFACIL"
   aList := { ;
   { "000073", "76169900" }, ;
   { "000101", "76169900" }, ;
   { "000102", "57033000" }, ;
   { "000103", "76169900" }, ;
   { "000104", "76169900" }, ;
   { "000105", "76169900" }, ;
   { "000106", "76169900" }, ;
   { "000107", "39269900" }, ;
   { "000108", "57033000" }, ;
   { "000109", "39269090" }, ;
   { "000110", "76169900" }, ;
   { "000111", "76169900" }, ;
   { "000112", "76169900" }, ;
   { "000113", "76169900" }, ;
   { "000114", "76169900" }, ;
   { "000115", "76169900" }, ;
   { "000116", "76169900" }, ;
   { "000117", "76169900" }, ;
   { "000118", "76169900" }, ;
   { "000119", "76169900" }, ;
   { "000120", "57033000" }, ;
   { "000121", "76169900" }, ;
   { "000122", "76169900" }, ;
   { "000123", "76169900" }, ;
   { "000124", "76169900" }, ;
   { "000125", "76169900" }, ;
   { "000126", "58089000" }, ;
   { "000127", "39269090" }, ;
   { "000128", "39269090" }, ;
   { "000129", "39269090" }, ;
   { "000130", "76169900" }, ;
   { "000131", "73251000" }, ;
   { "000132", "57033000" }, ;
   { "000133", "39269090" }, ;
   { "000134", "73251000" }, ;
   { "000135", "76169900" }, ;
   { "000136", "76169900" }, ;
   { "000137", "76169900" }, ;
   { "000138", "39269900" }, ;
   { "000139", "76169900" }, ;
   { "000140", "76169900" }, ;
   { "000141", "58089000" }, ;
   { "000142", "76169900" }, ;
   { "000143", "76169900" }, ;
   { "000144", "76169900" }, ;
   { "000145", "76169900" }, ;
   { "000146", "79169900" }, ;
   { "000147", "40169300" }, ;
   { "000148", "39269900" }, ;
   { "000149", "76169900" }, ;
   { "000150", "44219000" }, ;
   { "000151", "87049000" } }
   ENDIF
   IF AppEmpresaApelido() $ "PEATON"
   aList := { ;
   { "000001", "39269090" }, ;
   { "000002", "39269090" }, ;
   { "000003", "76169900" }, ;
   { "000004", "39269090" }, ;
   { "000005", "76169900" }, ;
   { "000006", "76169900" }, ;
   { "000007", "76169900" }, ;
   { "000008", "76169900" }, ;
   { "000009", "76169900" }, ;
   { "000010", "39269090" }, ;
   { "000011", "76042920" }, ;
   { "000012", "58089000" }, ;
   { "000013", "76169900" }, ;
   { "000014", "76169900" }, ;
   { "000015", "76169900" }, ;
   { "000016", "56049090" }, ;
   { "000017", "76169900" }, ;
   { "000018", "76169900" }, ;
   { "000019", "39269090" }, ;
   { "000020", "76169900" }, ;
   { "000021", "76169900" }, ;
   { "000022", "76169900" }, ;
   { "000023", "76169900" }, ;
   { "000024", "76169900" }, ;
   { "000025", "76169900" }, ;
   { "000026", "40169990" }, ;
   { "000027", "76169900" }, ;
   { "000028", "39269090" }, ;
   { "000029", "76169900" }, ;
   { "000030", "76169900" }, ;
   { "000031", "73251000" }, ;
   { "000032", "76169900" }, ;
   { "000033", "91118000" }, ;
   { "000034", "91118000" }, ;
   { "000035", "76169900" }, ;
   { "000036", "76169900" }, ;
   { "000037", "76169900" }, ;
   { "000038", "73251000" }, ;
   { "000039", "76169900" }, ;
   { "000040", "58089000" }, ;
   { "000041", "58089000" }, ;
   { "000042", "58089000" }, ;
   { "000043", "58089000" }, ;
   { "000044", "76169900" }, ;
   { "000045", "76169900" }, ;
   { "000046", "76169900" }, ;
   { "000048", "39269090" }, ;
   { "000049", "39269090" }, ;
   { "000050", "76169900" }, ;
   { "000051", "73251000" }, ;
   { "000052", "73251000" }, ;
   { "000053", "76169900" }, ;
   { "000054", "76042920" }, ;
   { "000055", "76169900" }, ;
   { "000056", "76169900" }, ;
   { "000057", "83024100" }, ;
   { "000058", "39205100" }, ;
   { "000059", "76169900" }, ;
   { "000060", "73251000" }, ;
   { "000061", "76169900" }, ;
   { "000062", "76169900" }, ;
   { "000063", "39269090" }, ;
   { "000064", "76169900" }, ;
   { "000065", "76169900" }, ;
   { "000066", "39269090" }, ;
   { "000067", "76169900" }, ;
   { "000068", "39205100" }, ;
   { "000069", "39205100" }, ;
   { "000070", "76169900" }, ;
   { "000071", "76169900" }, ;
   { "000072", "39269090" }, ;
   { "000073", "76169900" }, ;
   { "000074", "76169900" }, ;
   { "000075", "39269090" }, ;
   { "000076", "76169900" }, ;
   { "000077", "39269090" }, ;
   { "000078", "73251000" }, ;
   { "000079", "73251000" }, ;
   { "000080", "39269090" }, ;
   { "000081", "58063200" }, ;
   { "000082", "76169900" }, ;
   { "000083", "39269090" }, ;
   { "000084", "39269090" }, ;
   { "000085", "76169900" }, ;
   { "000086", "39269090" }, ;
   { "000087", "76169900" }, ;
   { "000088", "76169900" }, ;
   { "000089", "76169900" }, ;
   { "000090", "76169900" }, ;
   { "000091", "76169900" }, ;
   { "000092", "76169900" }, ;
   { "000093", "76169900" }, ;
   { "000094", "76169900" }, ;
   { "000095", "76169900" }, ;
   { "000096", "39269090" }, ;
   { "000097", "76169900" }, ;
   { "000098", "76169900" }, ;
   { "000099", "76169900" }, ;
   { "000100", "73251000" }, ;
   { "000101", "40169990" }, ;
   { "000102", "39269090" }, ;
   { "000103", "58089000" }, ;
   { "000104", "58089000" }, ;
   { "000105", "58089000" }, ;
   { "000106", "39269090" }, ;
   { "000107", "73251000" }, ;
   { "000108", "76169900" }, ;
   { "000109", "76169900" }, ;
   { "000110", "76169900" }, ;
   { "000111", "76169900" }, ;
   { "000112", "76169900" }, ;
   { "000113", "76169900" }, ;
   { "000114", "76169900" }, ;
   { "000115", "73251000" }, ;
   { "000116", "76169900" }, ;
   { "000117", "76169900" }, ;
   { "000118", "73251000" }, ;
   { "000119", "76169900" }, ;
   { "000120", "76169900" }, ;
   { "000121", "76169900" }, ;
   { "000122", "76169900" }, ;
   { "000123", "76169900" }, ;
   { "000124", "39269090" }, ;
   { "000125", "39029000" }, ;
   { "000126", "76169900" }, ;
   { "000127", "76169900" }, ;
   { "000128", "76169900" }, ;
   { "000129", "76169900" }, ;
   { "000130", "87042190" }, ;
   { "000131", "39269090" }, ;
   { "000132", "39269090" }, ;
   { "000133", "39205100" }, ;
   { "000134", "39205100" }, ;
   { "000135", "76169900" }, ;
   { "000136", "39269090" }, ;
   { "000137", "73251000" }, ;
   { "000138", "76169900" }, ;
   { "000139", "76169900" }, ;
   { "000140", "39269090" }, ;
   { "000141", "58089000" }, ;
   { "000142", "58089000" }, ;
   { "000143", "76169900" }, ;
   { "000144", "84807100" }, ;
   { "000145", "62069000" }, ;
   { "000146", "62069000" }, ;
   { "000147", "58071000" }, ;
   { "000148", "68006310" }, ;
   { "000149", "32121000" }, ;
   { "000150", "32121000" }, ;
   { "000151", "32121000" }, ;
   { "000152", "49089000" }, ;
   { "000153", "76169900" }, ;
   { "000154", "76169900" }, ;
   { "000155", "32121000" }, ;
   { "000156", "85312000" }, ;
   { "000157", "85319000" }, ;
   { "000158", "32121000" }, ;
   { "000159", "61091000" }, ;
   { "000160", "61034300" }, ;
   { "000161", "61032300" }, ;
   { "000162", "61013000" }, ;
   { "000163", "61143000" }, ;
   { "000164", "76169900" }, ;
   { "000165", "62069000" }, ;
   { "000166", "32121000" }, ;
   { "000167", "84186991" }, ;
   { "000168", "39269090" }, ;
   { "000169", "76169900" }, ;
   { "000170", "76169900" }, ;
   { "000171", "39269090" }, ;
   { "000172", "39269090" }, ;
   { "000173", "73251000" }, ;
   { "000174", "60063220" }, ;
   { "000175", "76169900" }, ;
   { "000176", "39269090" }, ;
   { "000177", "76169900" } }
   ENDIF
   IF AppEmpresaApelido() $ "UNIFILA"
   aList := { ;
   { "000001", "76169900" }, ;
   { "000002", "58089000" }, ;
   { "000003", "39269090" }, ;
   { "000004", "76169900" }, ;
   { "000005", "76169900" }, ;
   { "000006", "76169900" }, ;
   { "000007", "39269090" }, ;
   { "000008", "76141010" }, ;
   { "000009", "39269090" }, ;
   { "000010", "39269090" }, ;
   { "000011", "76169900" }, ;
   { "000012", "76169900" }, ;
   { "000013", "39269090" }, ;
   { "000014", "76169900" }, ;
   { "000015", "76169900" }, ;
   { "000016", "76169900" }, ;
   { "000017", "76169900" }, ;
   { "000018", "39269090" }, ;
   { "000019", "76169900" }, ;
   { "000020", "76169900" }, ;
   { "000021", "76169900" }, ;
   { "000022", "76169900" }, ;
   { "000023", "76169900" }, ;
   { "000024", "58063200" }, ;
   { "000025", "76169900" }, ;
   { "000026", "76169900" }, ;
   { "000027", "39269090" }, ;
   { "000028", "76169900" }, ;
   { "000029", "76169900" }, ;
   { "000030", "76169900" }, ;
   { "000031", "91118000" }, ;
   { "000032", "39231000" }, ;
   { "000033", "73261900" }, ;
   { "000034", "76169900" }, ;
   { "000035", "39269090" }, ;
   { "000036", "76169900" }, ;
   { "000037", "76169900" }, ;
   { "000038", "76169900" }, ;
   { "000039", "76169900" }, ;
   { "000040", "76169900" }, ;
   { "000041", "76169900" }, ;
   { "000042", "76169900" }, ;
   { "000043", "91118000" }, ;
   { "000044", "39033020" }, ;
   { "000045", "39081024" }, ;
   { "000046", "39269090" }, ;
   { "000047", "76169900" }, ;
   { "000048", "39269090" }, ;
   { "000049", "39081023" }, ;
   { "000050", "39081023" }, ;
   { "000051", "76169900" }, ;
   { "000052", "76169900" }, ;
   { "000053", "39031120" }, ;
   { "000054", "39269090" }, ;
   { "000055", "42021220" }, ;
   { "000056", "49100000" }, ;
   { "000057", "76169900" }, ;
   { "000058", "76169900" }, ;
   { "000059", "76169900" }, ;
   { "000060", "73251000" }, ;
   { "000061", "39269090" }, ;
   { "000062", "58089000" }, ;
   { "000063", "76169900" }, ;
   { "000064", "39269090" }, ;
   { "000065", "39269090" }, ;
   { "000066", "58063200" }, ;
   { "000067", "58063200" }, ;
   { "000068", "58063200" }, ;
   { "000069", "58063200" }, ;
   { "000070", "76169900" }, ;
   { "000071", "83100000" }, ;
   { "000072", "39269090" }, ;
   { "000073", "76169900" }, ;
   { "000074", "76169900" }, ;
   { "000075", "76169900" }, ;
   { "000076", "39033020" }, ;
   { "000077", "76169900" }, ;
   { "000078", "76169900" }, ;
   { "000079", "76169900" }, ;
   { "000080", "76169900" }, ;
   { "000081", "76042920" }, ;
   { "000082", "76169900" }, ;
   { "000083", "76169900" }, ;
   { "000084", "76169900" }, ;
   { "000085", "40169990" }, ;
   { "000086", "85098090" }, ;
   { "000087", "76169900" }, ;
   { "000088", "39269090" }, ;
   { "000089", "76169900" }, ;
   { "000090", "76169900" }, ;
   { "000091", "40169300" }, ;
   { "000092", "76169900" }, ;
   { "000093", "76042100" }, ;
   { "000094", "76169900" }, ;
   { "000095", "76169900" }, ;
   { "000096", "76169900" }, ;
   { "000097", "76169900" }, ;
   { "000098", "76042100" }, ;
   { "000099", "76169900" }, ;
   { "000100", "76169900" }, ;
   { "000101", "76169900" }, ;
   { "000102", "76169900" }, ;
   { "000103", "35061090" }, ;
   { "000104", "76169900" }, ;
   { "000105", "76169900" }, ;
   { "000106", "39081014" }, ;
   { "000107", "39205100" }, ;
   { "000108", "76169900" }, ;
   { "000109", "76169900" }, ;
   { "000110", "39031120" }, ;
   { "000111", "39205100" }, ;
   { "000112", "76169900" }, ;
   { "000113", "58089000" }, ;
   { "000114", "58089000" }, ;
   { "000115", "58089000" }, ;
   { "000116", "76169900" }, ;
   { "000117", "76169900" }, ;
   { "000118", "39269090" }, ;
   { "000119", "39269090" }, ;
   { "000120", "76169900" }, ;
   { "000121", "76169900" }, ;
   { "000122", "76169900" }, ;
   { "000123", "76169900" }, ;
   { "000124", "76169900" }, ;
   { "000125", "76169900" }, ;
   { "000126", "39205100" }, ;
   { "000127", "76169900" }, ;
   { "000128", "39269090" }, ;
   { "000129", "39269090" }, ;
   { "000130", "76169900" }, ;
   { "000131", "58063200" }, ;
   { "000132", "40161090" }, ;
   { "000133", "39033020" }, ;
   { "000134", "39081024" }, ;
   { "000135", "39081024" }, ;
   { "000136", "76169900" }, ;
   { "000137", "73064000" }, ;
   { "000138", "73251000" }, ;
   { "000139", "73251000" }, ;
   { "000140", "76169900" }, ;
   { "000141", "76169900" }, ;
   { "000142", "39029000" }, ;
   { "000143", "76042100" }, ;
   { "000144", "76082010" }, ;
   { "000145", "76169900" }, ;
   { "000146", "83024100" }, ;
   { "000147", "58089000" }, ;
   { "000148", "39205100" }, ;
   { "000149", "39205100" }, ;
   { "000150", "76169900" }, ;
   { "000151", "76169900" }, ;
   { "000152", "73064000" }, ;
   { "000153", "83024100" }, ;
   { "000154", "73251000" }, ;
   { "000155", "84807000" }, ;
   { "000156", "40169990" }, ;
   { "000157", "39219090" }, ;
   { "000158", "76042920" }, ;
   { "000159", "76169900" }, ;
   { "000160", "76169900" }, ;
   { "000161", "76169900" }, ;
   { "000162", "76169900" }, ;
   { "000163", "39269090" }, ;
   { "000164", "73251000" }, ;
   { "000165", "39031900" }, ;
   { "000166", "39081024" }, ;
   { "000167", "39269090" }, ;
   { "000168", "39151000" }, ;
   { "000169", "39269090" }, ;
   { "000170", "39031120" }, ;
   { "000171", "76169900" }, ;
   { "000172", "76169900" }, ;
   { "000173", "76169900" }, ;
   { "000174", "39269090" }, ;
   { "000175", "76169900" }, ;
   { "000176", "39269090" }, ;
   { "000177", "39269090" }, ;
   { "000178", "39269090" }, ;
   { "000179", "39151000" }, ;
   { "000180", "85014019" }, ;
   { "000181", "39081024" }, ;
   { "000182", "39081024" }, ;
   { "000183", "39081024" }, ;
   { "000184", "38259000" }, ;
   { "000185", "84807900" }, ;
   { "000186", "76169900" }, ;
   { "000187", "76169900" }, ;
   { "000188", "39205100" }, ;
   { "000189", "76169900" }, ;
   { "000190", "76169900" }, ;
   { "000191", "58089000" }, ;
   { "000192", "76169900" }, ;
   { "000193", "39219019" }, ;
   { "000194", "58063200" }, ;
   { "000195", "76169900" }, ;
   { "000196", "85098090" }, ;
   { "000197", "76169900" }, ;
   { "000198", "76169900" }, ;
   { "000199", "76169900" }, ;
   { "000200", "39304900" }, ;
   { "000201", "39203000" }, ;
   { "000202", "39304900" }, ;
   { "000203", "39033020" }, ;
   { "000204", "39304900" }, ;
   { "000205", "39269090" }, ;
   { "000206", "76169900" }, ;
   { "000207", "39269090" }, ;
   { "000208", "87042190" }, ;
   { "000209", "76169900" }, ;
   { "000210", "39269090" }, ;
   { "000211", "39269090" }, ;
   { "000212", "94031000" }, ;
   { "000213", "76169900" }, ;
   { "000214", "76169900" }, ;
   { "000215", "76169900" }, ;
   { "000216", "76169900" }, ;
   { "000217", "73251000" }, ;
   { "000218", "76169900" }, ;
   { "000219", "58063200" }, ;
   { "000220", "39269090" }, ;
   { "000221", "76169900" }, ;
   { "000222", "76169900" }, ;
   { "000223", "84439990" }, ;
   { "000224", "48114990" }, ;
   { "000225", "76169900" }, ;
   { "000226", "39269090" }, ;
   { "000227", "76169900" }, ;
   { "000228", "76169900" }, ;
   { "000229", "39269090" }, ;
   { "000230", "73251000" }, ;
   { "000231", "84743100" }, ;
   { "000232", "39269090" }, ;
   { "000233", "39269090" }, ;
   { "000234", "73181500" }, ;
   { "000235", "39269090" }, ;
   { "000236", "76169900" }, ;
   { "000237", "39269090" }, ;
   { "000238", "76169900" }, ;
   { "000239", "85312000" }, ;
   { "000240", "85319000" }, ;
   { "000241", "39206900" }, ;
   { "000242", "39206900" }, ;
   { "000243", "85312000" }, ;
   { "000244", "85319000" }, ;
   { "000245", "39269090" }, ;
   { "000246", "87042190" }, ;
   { "000247", "85312000" }, ;
   { "000248", "39269090" }, ;
   { "000249", "39269090" }, ;
   { "000250", "76169900" }, ;
   { "000251", "39269090" }, ;
   { "000252", "58063200" }, ;
   { "000253", "73251000" }, ;
   { "000254", "39269090" }, ;
   { "000255", "73251000" }, ;
   { "000256", "48025592" }, ;
   { "000257", "76169900" }, ;
   { "000258", "76169900" }, ;
   { "000259", "76169900" }, ;
   { "000260", "76169900" }, ;
   { "000261", "76169900" }, ;
   { "000262", "39269090" }, ;
   { "000263", "76169900" }, ;
   { "000264", "39269090" } }
   ENDIF

   IF ! AbreArquivos( "jpitem" )
      QUIT
   ENDIF
   GrafTempo( "Retornando NCM" )
   FOR EACH oElement IN aList
      GrafTempo( oElement:__EnumIndex, Len( aList ) )
      IF Encontra( oElement[ 1 ], "jpitem" ) .AND. Empty( jpitem->ieNcm )
         RecLock()
         REPLACE jpitem->ieNcm WITH oElement[ 2 ]
      ENDIF
   NEXT
   CLOSE DATABASES

   RETURN NIL
